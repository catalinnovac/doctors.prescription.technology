<!DOCTYPE html>
<html>
	<head>
		<title>Prescription Technology</title>
		<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
		<link rel="stylesheet" type="text/css" href="css/reset.css" media="screen" />
		<link rel="stylesheet" type="text/css" href="css/responsive.gs.24col.css" media="screen" />
		<link rel="stylesheet" type="text/css" href="css/font-awesome.min.css" />
		<link rel="stylesheet" type="text/css" href="css/styles.css" media="screen" />
		<script type="text/javascript" src="cordova.js"></script>
		<script type="text/javascript" src="js/respond.min.js"></script>
		<script type="text/javascript" src="js/jquery-1.10.2.min.js"></script>
		<script type="text/javascript" src="js/custom.jquery.js"></script>
		<link href="https://fonts.googleapis.com/css?family=Open+Sans:400,300,300italic,400italic,600,600italic,700,800,700italic" rel="stylesheet" type="text/css" />
	</head>
	<body id="index">
		<!-- Preloader -->
		<div id="page-preloader">
			<img class="preloader" src="img/loading.gif" alt=""/>
		</div>
		
		<div class="container wrap">
			<div class="row gutters">
				<div class="col span_24">
					<a href="/" id="logo" title="Prescription Technology - Doctors Interface" /><img src="img/logo_PT.png" alt="" /></a>
					<a href="/" id="nav-toggle" title="Prescription Technology - Doctors Interface Menu" />Menu</a>
				</div>
			</div>
			<div class="row gutters">
				<div class="col span_24">
					<h1>Declined</h1>

				    <div id="declined">
				        <div id="clonable">
				            <div class="edit-buttons">
				                <a class="oid_url"></a>
				            </div>
				            <div class="customer-placeholder">
				                <h3 class="customer">
				                    <span class="autoupdate" data-term="firstname"></span><span class="autoupdate" data-term="middleinitial"></span><span class="autoupdate" data-term="lastname"></span>
								</h3>
								<div class="customer-addresses">
									<div class="customer-shipping-addresses">
										<div class="customer-shipping-address clonable">
											<p class="autoupdate" data-term="Street"></p>
											<p class="autoupdate" data-term="City"></p>
											<p class="autoupdate" data-term="Province"></p>
											<p class="autoupdate" data-term="Postal_Code"></p>
											<p class="autoupdate" data-term="Country"></p>
										</div>
									</div>
									<div class="customer-billing-addresses">
										<div class="customer-billing-address clonable">
											<p class="autoupdate" data-term="Street"></p>
											<p class="autoupdate" data-term="City"></p>
											<p class="autoupdate" data-term="Province"></p>
											<p class="autoupdate" data-term="Postal_Code"></p>
											<p class="autoupdate" data-term="Country"></p>
										</div>
									</div>
								</div>
							</div>
				            <div class="treatment">
				                <p class="autoupdate" data-term="oid"></p>
				                <p class="autoupdate" data-term="orderdate"></p>
				                <p class="autoupdate" data-term="status"></p>
				                <ul class="meds-list">
				                    <li class="clonable"><p class="autoupdate" data-term="MedName"></p></li>
				                </ul>
				            </div>
							<!--
				            <div class="assign_date">
				                <p class="autoupdate" data-term="Assign_date"></p>
				            </div>
							-->
				        </div>
						<div id="response-holder" data-url="http://doctors.prescription.technology/ws/declinedorders.asp"></div>
				    </div>
				</div>
			</div>
		</div>

		<footer class="container wrap">
			<div class="row gutters">
				<div class="col span_12">
					This software and all connected databases are the exclusive property of
					<strong>HR Healthcare Ltd</strong><br>
					All rights are reserved by <strong>HR Healthcare Ltd, The Office, Britannia Way, Waters Meeting, Bolton, BL2
					2HH. 01204 559 999</strong> <br>
					All Intellectual Property Rights belong to <strong>HR Healthcare Ltd, The Office, Britannia Way, Waters Meeting,
					Bolton, BL2 2HH. 01204 559 999</strong>
				</div>
				<div class="col span_12">
					Any use, editing, changing, multiplication or commercial
					use (including but not limited to selling, licensing of this software
					and/or parts of it and/or its connected database information), independent
					of any changes being done first, is prohibited.
				</div>
			</div>
		</footer>

		<script type="text/javascript">
			function PowerUp() {
				var oLocalStorage = new classLocalStorage();
				var $clonable = $('#clonable');
				var $responseHolder = $('#response-holder');
				var $pagePreloader = $('#page-preloader');
				$pagePreloader.show();
				
				$('#nav-toggle').on('touchstart click', function(e){
					e.preventDefault();
                    var extra = new Array();
                    extra.push({ key:"open",value:"1"});
                    doctors.sendMessage("DRAWER",JSON.stringify(extra));
				});

                $.ajax({
                    url: $responseHolder.data('url'),
                    type: 'GET',
                    beforeSend: function (xhr) { if (typeof doctors != 'undefined') { xhr.setRequestHeader('Authorization', doctors.getToken()); } }
                }).fail(function (response) { 
						// Failure
						var json = $.parseJSON(response);
						var messages = ''
										+ '<p class="alert error">status: ' + json.status + '</p>'
										+ '<p class="alert error">message: ' + json.message + '</p>'
										;
						$responseHolder.append(messages).show();
				}).done(function (dataRaw, textStatus, xhr) {
                    var data = JSON.parse(dataRaw);
                    if (data.Declined_Orders.length > 0) {
						var $editLink = false;
                        //for (var i = 0; i < data.Declined_Orders.length; i++) {
                        var current_data = false;
                        var $clone = false;
						for (var i = 0; i < 5; i++) {
							$clone = $clonable.clone(true);
                            current_data = data.Declined_Orders[i];
                            $clone.prop("id", "_" + current_data.OrderNumber.oid).addClass('clone');

							$editLink = $clone.find("a.oid_url"); 
							$editLink.prop('href', current_data.OrderNumber.oid_url);
							
							/*
							console.log('current_data.customer: ' + current_data.customer);
							console.log('current_data.customer.length: ' + current_data.customer.length);
							console.log('current_data.Treatment: ' + current_data.Treatment);
							console.log('current_data.Treatment.length: ' + current_data.Treatment.length);
							console.log('current_data.customer.Shipping_address: ' + current_data.customer.Shipping_address);
							console.log('current_data.customer.Shipping_address.length: ' + current_data.customer.Shipping_address.length);
							console.log('current_data.customer.Billing_address: ' + current_data.customer.Billing_address);
							console.log('current_data.customer.Billing_address.length: ' + current_data.customer.Billing_address.length);
							console.log('current_data.Treatment.Meds: ' + current_data.Treatment.Meds);
							//console.log('current_data.Assign_date: ' + current_data.Assign_date);
                            */
							
							oLocalStorage.UpdatePageElements(current_data.customer);
							console.log('end UpdatePageElements(current_data.customer)');
							oLocalStorage.UpdatePageElements(current_data.Treatment);
							console.log('end UpdatePageElements(current_data.Treatment)');
							
							/* Shipping addresses */
							var $csaCloneHolder = $('.customer-shipping-addresses');
							var $csaClone = $('.customer-shipping-address.clonable');
							for (var k = 0; k < current_data.customer.Shipping_address.length ; k++) {
								oLocalStorage.UpdatePageElements(current_data.customer.Shipping_address[k], $csaClone);
                                $csaClone.appendTo($csaCloneHolder);
								console.log('end UpdatePageElements(current_data.customer.Shipping_address['+k+'])');
                            }
							/* Billing addresses */
							var $cbaCloneHolder = $('.customer-billing-addresses');
							var $cbaClone = $('.customer-billing-address.clonable');
							for (var k = 0; k < current_data.customer.Billing_address.length ; k++) {
								oLocalStorage.UpdatePageElements(current_data.customer.Billing_address[k], $cbaClone);
                                $cbaClone.appendTo($cbaCloneHolder);
								console.log('end UpdatePageElements(current_data.customer.Billing_address['+k+'])');
                            }
							
							/* Treatment Meds */
							var $medsList = $clone.find('.meds-list');
                            var $li = $medsList.find("li.clonable").clone(true);
                            for (var j = 0; j < current_data.Treatment.Meds.length ; j++) {
								oLocalStorage.UpdatePageElements(current_data.Treatment.Meds[j], $li);
                                $li.appendTo($medsList);
								console.log('end UpdatePageElements(current_data.Treatment.Meds['+j+'])');
                            };
							
							/* Assign Date */
							//oLocalStorage.UpdatePageElements(current_data.Assign_date, $clone.find(".assign_date"));
							
							/* Set the clone alive */
                            $clone.appendTo($responseHolder);
                        }
                    } else {
						messages = '<p>No history yet</p>';
						$responseHolder.append(messages).show();
                    }
                    var extra = new Array();
                    extra.push({ key: "open", value: "0" });
                    doctors.sendMessage("DRAWER", JSON.stringify(extra));
				}).always(function() {
					$pagePreloader.fadeOut();
				});
            };
			$(function() {
	            document.addEventListener("deviceready", PowerUp, false);
				
				/* Only for in-browser (not in Android) testing */
				//PowerUp();
			})
	    </script>
	</body>
</html>